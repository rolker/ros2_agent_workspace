name: Test Agent Instructions

on:
  pull_request:
    paths:
      - '.agent/**'
      - '.github/copilot-instructions.md'
      - '.github/instructions/**'
  workflow_dispatch:
  schedule:
    # Run nightly to detect instruction drift
    - cron: '0 2 * * *'

jobs:
  test-instructions:
    name: Promptfoo Agent Tests
    runs-on: ubuntu-latest
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
    
    permissions:
      contents: read
      pull-requests: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      
      - name: Check API keys
        run: |
          if [ -z "${{ secrets.ANTHROPIC_API_KEY }}" ] || [ -z "${{ secrets.GOOGLE_API_KEY }}" ]; then
            echo "âŒ API keys not configured. Required: ANTHROPIC_API_KEY and GOOGLE_API_KEY"
            echo "See .agent/testing/README.md for setup instructions"
            exit 1
          fi
      
      - name: Run Promptfoo tests
        working-directory: .agent/testing
        timeout-minutes: 5  # Timeout after 5 minutes (expected: ~1 minute)
        run: npx promptfoo@0.120.21 eval
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
      
      - name: Generate test summary
        if: always()
        run: |
          cd .agent/testing
          
          # Check if output.json exists
          if [ ! -f .promptfoo/output.json ]; then
            echo "âŒ No test results found - tests may not have executed"
            echo "::error::Promptfoo tests did not produce output.json"
            exit 1
          fi
          
          # Parse results with error handling
          if ! TOTAL=$(jq -e '.results.results | length' .promptfoo/output.json); then
            echo "Error: Failed to parse total test count from .promptfoo/output.json"
            exit 1
          fi
          if ! PASSED=$(jq -e '[.results.results[] | select(.success == true)] | length' .promptfoo/output.json); then
            echo "Error: Failed to parse passed test count from .promptfoo/output.json"
            exit 1
          fi
          if ! FAILED=$(jq -e '[.results.results[] | select(.success == false)] | length' .promptfoo/output.json); then
            echo "Error: Failed to parse failed test count from .promptfoo/output.json"
            exit 1
          fi
          
          # Create summary for GitHub Actions
          echo "## ðŸ§ª Agent Instruction Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Results:** âœ… $PASSED passed | âŒ $FAILED failed | **Total:** $TOTAL tests" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ $FAILED -gt 0 ]; then
            echo "### âŒ Failed Tests" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            jq -r '.results.results[] | select(.success == false) | 
              "#### " + (.prompt.label | split("\n")[0] | .[0:80]) + "\n" +
              "**Reason:** " + .gradingResult.reason + "\n" +
              "<details><summary>View full output</summary>\n\n```\n" + .response.output + "\n```\n</details>\n"
            ' .promptfoo/output.json >> $GITHUB_STEP_SUMMARY
          fi
          
          # Save summary for PR comment
          echo "$PASSED" > /tmp/passed_count
          echo "$FAILED" > /tmp/failed_count
          echo "$TOTAL" > /tmp/total_count
          
          if [ $FAILED -gt 0 ]; then
            jq -r '.results.results[] | select(.success == false) | 
              "### âŒ " + (.prompt.label | split("\n")[0] | .[0:100]) + "\n" +
              "**Reason:** " + .gradingResult.reason + "\n"
            ' .promptfoo/output.json > /tmp/failures.md
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: promptfoo-results
          path: .agent/testing/.promptfoo/
          retention-days: 30
          include-hidden-files: true
      
      - name: Comment on PR
        if: always() && github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let passed = 0, failed = 0, total = 0;
            try {
              passed = parseInt(fs.readFileSync('/tmp/passed_count', 'utf8').trim());
              failed = parseInt(fs.readFileSync('/tmp/failed_count', 'utf8').trim());
              total = parseInt(fs.readFileSync('/tmp/total_count', 'utf8').trim());
            } catch (e) {
              console.log('Could not read test counts, skipping comment');
              return;
            }
            
            let body = `## ðŸ§ª Agent Instruction Test Results\n\n`;
            body += `**Results:** âœ… ${passed} passed | âŒ ${failed} failed | **Total:** ${total} tests\n\n`;
            
            if (failed > 0) {
              try {
                const failures = fs.readFileSync('/tmp/failures.md', 'utf8');
                body += `${failures}\n`;
              } catch (e) {
                body += `See workflow artifacts for failure details.\n`;
              }
              body += `\nðŸ“Ž [Download full test results](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\n`;
            } else {
              body += `ðŸŽ‰ All tests passed!\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });


